<link href="http://kevinburke.bitbucket.org/markdowncss/markdown.css" rel="stylesheet"></link>
Poverty by District in Israel, mapped
---
# clone this directory to reproduce

## 0. Data preparation

Make fake data of the same style as Nepal estimates. But for many fewer districts. Use
Isreali district names.


Lets load up the data and the "NepalMapUtils" library. This works fine if you do a [setwd](http://www.statmethods.net/interface/workspace.html) to inside the `Poverty` folder within the [NepalMaps](http://github.com/prabhasp/NepalMaps) repository.

```{r echo=T, comment=NA, fig.height=6, fig.width=10, cache=TRUE}
getwd()
# setwd(...) here
poverty11 <- read.csv("ILEstimates2011.csv")
source("../IsraelMapUtils.R")
```

We will do one tranformation before proceeding, which is to rename our columns. In the dataset, "FGT(0)" (which loads in R as `FGT.0.` because R doesn't like parentheses) is the _poverty incidence_ metric, defined as proportion of individuals living in that area who are in households with an average per capita expenditure below the poverty line. FGT(1) is the _poverty gap_, which is the average distance below the poverty line, being zero for those individuals above the line, and FGT(2) is _poverty severity_, the squared distance for those below hte line, which gives more weight to the very poor. [(See 2006 report for definitions)](http://cbs.gov.np/wp-content/uploads/2012/Others/SAE%20of%20Poverty,%20Caloric%20Intake%20and%20Malnutrition%20in%20Nepal.pdf).

So lets go ahead and rename our columns to these understandable names:
```{r}
names(poverty11)
names(poverty11) <- c("District", "Population", "PovertyIncidence", "S.E-P.I.", "PovertyGap", 
                    "S.E-P.G." , "PovertySeverity", "S.E-P.S.")
```

And now we will also load the 2001 data, which has been modified to have the exact same column names already:

```{r echo=T, comment=NA, fig.height=6, fig.width=10, cache=TRUE}
poverty2001 <- read.csv("ILEstimates2001.csv")
```

## squished map

### wow this is great! 
This codebase really got me moving quickly.

 Lets make a quick map of it (note that I haven't paid attention to map projections: these are sketches).
```{r echo=T, comment=NA, fig.height=7., fig.width=7, cache=TRUE}
npchoropleth(poverty11, 'District', 'PovertyIncidence')
```

A second map, coloring those that are above the mean (weighted by population) as blue and those below as red:
```{r echo=T, comment=NA, fig.height=8, fig.width=10, cache=TRUE, message=F}
meanpoverty <- weighted.mean(poverty11$PovertyIncidence, poverty11$Population)
npchoropleth(poverty11, 'District', 'PovertyIncidence') + scale_fill_gradient2(low=muted('blue'), midpoint=meanpoverty, mid='white', high=muted('red'))
```

In the second map, you can really see ...

## 2. Absolute poor (2011)

The next thing to look at, as Chandan did, is the number of absolute poor, which is easily calculable given that population is nicely included in this dataset. Lets have a look:
```{r echo=T, comment=NA, fig.height=7.2, fig.width=12, cache=TRUE}
poverty11$AbsolutePoor <- poverty11$Population * poverty11$PovertyIncidence
npchoropleth(poverty11, 'District', 'AbsolutePoor')
```
The absolute poor are concentrated in ...

For reference, a population sketch to remind us where people live in Israel:
```{r echo=T, comment=NA, fig.height=7.2, fig.width=12, cache=TRUE}
npchoropleth(poverty11, 'District', 'Population')
```

3. Comparisons with 2001
===

Now, lets us compare the data to the 2001 small area povery estimates. We will first create a new dataframe containing data from both years, then take the difference and map it (while remembering to flip the color scheme, a decrease is poverty incidence is good!):

```{r echo=T, comment=NA, fig.height=7.2, fig.width=12, cache=TRUE, message=FALSE}
poverty <- merge(poverty11, poverty2001, by="District", suffixes=c("_2011", "_2001"))
poverty$PovertyTenYrChange <- poverty$PovertyIncidence_2011 - poverty$PovertyIncidence_2001
npchoropleth(poverty, 'District', 'PovertyTenYrChange') + 
  scale_fill_gradient2(low=muted('blue'), high=muted('red'))
```

The units here are in difference of percentage points; bigger negative numbers are better. The message here seems to be that . . . 

## Disclaimer. . . simulated data.

## Next steps:

1. use this code base with real data.

2. examine objects made by csvs, make real data in these formats (data frames?)

# get some real data - population by district
http://cbs.gov.il/shnaton67/download/st02_22.xls
```{r}
# need to wrap this in a check for the file on the local machine
# then not download twice

# download instructions: http://stackoverflow.com/questions/24146124/how-to-download-a-file-using-rcurl
#setwd("/Users/AbuDavid/scratch/IsraeliChoropleths/")
#doc<-RCurl::getBinaryURL("http://cbs.gov.il/shnaton67/download/st02_22.xls")
#writeBin(as.vector(doc),"../data/st02_22.xls")

```
read the data
```{r}
popData <-rio::import("../data/st02_22.xls", format="xls")
##  View(popData) ## doesn't get the rows correct
## data published Sept. 1, 2016
df1 <- xlsx::read.xlsx("../data/st02_22.xls",
                sheetIndex = 1)
df2 <- xlsx::read.xlsx("../data/st02_22.xls",
                sheetIndex = 2)
#View(df1)
#View(df2)
# visually inspect data, I want the NA..2 column
typeof(df1)
df3<-as.data.frame(df1)
df4<-as.data.frame(df2)
z<-colnames(df1)
colnames(df3)[4]  <- "pop2016"
colnames(df4)[4]  <- "pop2016"
# rename NA..2 for ease of use
# read in population in thousands
jeruPop <- df3$pop2016[20]  
jeruPop
haifaPop <- df3$pop2016[40]  
haZafonPop <- df3$pop2016[22]  #north
haMercazPop <- df4$pop2016[12] #central #2nd sheet of xls
haDaromPop <- df4$pop2016[27]  #south   #2nd sheet of xls
telAvivPop <- 1258.77 #2008 pop source: http://www.cbs.gov.il/www/mifkad/mifkad_2008/tables/dem1_2.xls 
golanPop <- df3$pop2016[25]  
typeof(golanPop)
```
### look at the fake data
### copy
### insert real population data
```{r}
View(poverty11)
rownames(poverty11)
colnames(poverty11)
```
```{r}
poverty11$District
```
```{r}
poverty11$District[1]
population2016<-poverty11
population2016$Population[1]<-golanPop
population2016$Population[2]<-haDaromPop
population2016$Population[3]<-haifaPop
population2016$Population[4]<-haMercazPop
population2016$Population[5]<-haZafonPop
population2016$Population[6]<-jeruPop
population2016$Population[7]<-telAvivPop
```
## show the actual population of IL in choropleth
### adapt the graphing code

```{r echo=T, comment=NA, fig.height=7.2, fig.width=12, cache=TRUE}
npchoropleth(population2016, 'District', 'Population')
```
Wow, is that correct? Is the population density really that skewed? Let's view a table.
```{r}
View(population2016) 
# Jerusalem pop is 53,000 in the .xls, and in my variable, but only 19 after it is saved in the table. 
# is my pop correct for Jerusalem district? or for the city?
# need to match it with the same definition used in the housing portion.
```

